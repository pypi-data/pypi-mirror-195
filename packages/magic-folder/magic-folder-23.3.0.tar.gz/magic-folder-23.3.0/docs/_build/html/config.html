

<!DOCTYPE html>
<html class="writer-html4" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Configuration Storage &mdash; Magic-Folder 1.x documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="_static/custom.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script type="text/javascript" src="_static/jquery.js"></script>
        <script type="text/javascript" src="_static/underscore.js"></script>
        <script type="text/javascript" src="_static/doctools.js"></script>
        <script type="text/javascript" src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home"> Magic-Folder
          

          
          </a>

          
            
            
              <div class="version">
                1.x
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="usage.html">Using Magic Folder</a></li>
<li class="toctree-l1"><a class="reference internal" href="invites.html">How invites work</a></li>
<li class="toctree-l1"><a class="reference internal" href="limitations.html">Known Issues and Limitations</a></li>
<li class="toctree-l1"><a class="reference internal" href="backdoors.html">Statement on Backdoors</a></li>
<li class="toctree-l1"><a class="reference internal" href="development.html">Magic-Folder Development</a></li>
<li class="toctree-l1"><a class="reference internal" href="proposed/index.html">Proposed Specifications</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">Magic-Folder</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Configuration Storage</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="_sources/config.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="configuration-storage">
<span id="config"></span><h1>Configuration Storage<a class="headerlink" href="#configuration-storage" title="Permalink to this headline">¶</a></h1>
<p>If you are looking for the description of the current
configuration-storage mechanisms, skip down to <a class="reference internal" href="#current"><span class="std std-ref">the current
storage description</span></a>.</p>
<div class="section" id="context-and-history">
<h2>Context and History<a class="headerlink" href="#context-and-history" title="Permalink to this headline">¶</a></h2>
<p><cite>magic-folder</cite> originally was extracted from Tahoe-LAFs where it was a
sub-command / sub-system. Thus, it inherited Tahoe’s method of
configuration. This is a menagerie of various files in a “node
directory” including a <cite>tahoe.cfg</cite> INI-style file. There is a
<cite>private/</cite> sub-directory which often has “extra-private” information
(like secret keys).</p>
<p>Although a magic-folder is necessarily tied to a Tahoe-LAFS client we
don’t <em>need</em> to store our configuration there.</p>
<p>We have decided that a user upgrading from a <cite>tahoe magic-folder</cite>
style Magic Folder to a stand-alone Magic Folder will run
<cite>magic-folder migrate</cite>. This allows us the freedom to store our
configuration in any way we like.</p>
</div>
<div class="section" id="legacy-configuration-and-state">
<h2>Legacy Configuration and State<a class="headerlink" href="#legacy-configuration-and-state" title="Permalink to this headline">¶</a></h2>
<p>In versions of Tahoe-LAFS that had magic-folder enabled, the following
configuration could be used:</p>
<ul class="simple">
<li><cite>enabled</cite> (bool) from <cite>tahoe.cfg [magic_folder]</cite></li>
<li><cite>local.directory</cite> (from <cite>tahoe.cfg [magic_folder]</cite>)</li>
<li><cite>poll_interval</cite> (from <cite>tahoe.cfg [magic_folder]</cite>)</li>
<li>“magic folders” dict from
<cite>&lt;node_dir&gt;/private/magic_folders.yaml</cite>. This uses magic-folder
“names” as keys with the following valid keys as sub-dicts:
- <cite>directory</cite>: local path to the “magic folder”
- <cite>poll_interval</cite>: how often to poll (in seconds)
- <cite>collective_dircap</cite>: read-cap of the shared directory (list of users)
- <cite>upload_dircap</cite>: write-cap of our mutable directory
- <cite>umask</cite>: the umask to use for downloaded files</li>
<li><cite>&lt;node_dir&gt;/private/magicfolder_&lt;name&gt;.sqlite</cite> the local sqlite
database for tracking state</li>
</ul>
<p>Related, Tahoe-LAFS has a token in <cite>&lt;node_dir&gt;/private/api_auth_token</cite>
which is required to access parts of the Web API. This isn’t directly
part of magic-folder’s configuration (however, standalone magic-folder
will also use such a token).</p>
</div>
<div class="section" id="what-needs-to-be-stored">
<h2>What Needs to be Stored<a class="headerlink" href="#what-needs-to-be-stored" title="Permalink to this headline">¶</a></h2>
<p>As we are currently re-designing the storage mechanism, some of this
might change. However, based on current understanding the state we
WANT to store is:</p>
<ul>
<li><p class="first">for each magic-folder (indexed by “name”):
- local directory path (the “magic folder”)
- an author:</p>
<blockquote>
<div><ul class="simple">
<li>name</li>
<li>private_key (32 bytes, a NaCl signing key)</li>
</ul>
</div></blockquote>
<ul class="simple">
<li>a write-cap of our mutable directory</li>
<li>some state (see below)</li>
</ul>
</li>
<li><p class="first">the node-directory of our Tahoe-LAFS client
- we may need the <cite>private/api_auth_token</cite>
- we will need the <cite>node.url</cite> (at least)
- (it MAY be sufficient to only store the API endpoint (the contents</p>
<blockquote>
<div><p>of <cite>node.url</cite>), not node-directory. If it’s feasible to only store
the API endpoint, we should do that instead of caring about the
node-directory. It would probably still be convenient to refer to
a Tahoe client by node-directory (but we can just pull out the
Web-API endpoint). If we only store the endpoint and the Tahoe
config changes, the user would also have to change their
magic-folder config.</p>
</div></blockquote>
</li>
<li><p class="first">our own API endpoint (a Twisted server endpoint-string,
e.g. <cite>tcp:1234</cite> or <cite>unix:/tmp/foo</cite>)</p>
</li>
</ul>
<p>State that we need to store:</p>
<ul class="simple">
<li>a secret token that protects the API (only users who can read the
file can access the endpoint)</li>
<li>list of other participants (per magic-folder) (see note)</li>
<li>local cache of remote snapshots (probably per-magic folder)</li>
<li>local copy of snapshots we haven’t yet uploaded (probably per-magic folder)
- metadata details of the snapshot
- “stash directory” for file-data of the snapshot</li>
</ul>
<p>NOTE: Currently the “list of other participants” comes from the
“collective dircap” but in the Leif Design each user decides whom they
wish to pull updates from. So, the “list of other participants” above
might be “a readcap of a directory” (and we would determine the actual
list at runtime by reading that capability).</p>
</div>
<div class="section" id="ui-to-change-the-config">
<h2>UI to Change the Config<a class="headerlink" href="#ui-to-change-the-config" title="Permalink to this headline">¶</a></h2>
<p>Writing configuration files is hard, error-prone and not a great
interface. It also makes it hard (or impossible) to change where or
how configuration is stored. All configuration shall be changed by an
HTTP API. There will also be CLI commands that are thin wrappers of
the HTTP API. GUI front-ends could use the command-line or the HTTP
API. Nothing except the HTTP API should be touching the actual stored
configuration.</p>
<p>(Of course we can’t stop users from editing the config files
themselves, but this should be discouraged).</p>
</div>
<div class="section" id="where-and-how-to-store-the-configuration">
<span id="current"></span><h2>Where and How To Store the Configuration<a class="headerlink" href="#where-and-how-to-store-the-configuration" title="Permalink to this headline">¶</a></h2>
<p>Somewhat mirroring Tahoe-LAFS’s design, configuration shall all be
found in a single directory. This directory can be specified via
command-line option. (Should we have a default? Seems sensible, most
OSes have a reasonably well-defined place for programs to store
configuration data).</p>
<p>All global configuration and state shall be stored in an SQLite3
database. This database will have tables for global configuration and
state.</p>
<p>The “configuration directory” will look like this:</p>
<ul class="simple">
<li><cite>confdir</cite> (e.g. <cite>~/.config/magic-folder</cite>)
- <cite>global.sqlite</cite>
- <cite>api_token</cite>: 32 bytes of binary data
- <cite>magic_folder.pid</cite>: contains the PID of the currently-running process</li>
</ul>
<p>The <cite>global.sqlite</cite> database will have the following tables:</p>
<ul>
<li><p class="first">“version” with a single row containing “1”</p>
</li>
<li><p class="first">“magic_folders”
- columns:
- <cite>name</cite> is a unique unicode string the user provides to identify this folder
- <cite>location</cite> is a local path for that folder’s configuration</p>
</li>
<li><p class="first">“config”
- columns:
- <cite>api_endpoint</cite> is a Twisted server string description
- <cite>tahoe_node_directory</cite> is the node-directory of our Tahoe-LAFS</p>
<blockquote>
<div><p>client</p>
<p>Note: Ideally, we’d only need the Web-API URI however that can be
configured in tahoe to be randomly-assigned on startup and so we
should read the URI from <cite>node.url</cite>. There may be other
configuration we’ve neglected (since magic-folder used to be
inside Tahoe) so this also allows us to fix that later too.</p>
</div></blockquote>
</li>
</ul>
<p>Each “magic folder” location is a directory containing the
stash-directory and state for that magic-folder. It will look like
this:</p>
<ul class="simple">
<li><cite>&lt;magic folder location&gt;/</cite>
- <cite>README</cite>: a file containing information about magic-folder
- <cite>state.sqlite</cite>: the state database
- <cite>stash/</cite>: the stash-directory containing LocalSnapshot content</li>
</ul>
<p>The <cite>state.sqlite</cite> for each magic-folder shall contain the following
tables:</p>
<ul class="simple">
<li>“version” (will always contain 1 row)
- column:
- “version” is an int, currently <cite>1</cite></li>
<li>“config” (will always contain 1 row)
- columns:
- “author_name” is a string of unicode
- “author_private_key” is a 32-byte blob (a NaCl Signing key)
- “stash_path” is a local path where we stash data awaiting upload
- “collective_dircap” is a read-capability-string which defines the magic-folder
- “upload_dircap” is a write-capability-string defining where we put our snapshots
- “magic_directory” is a local path to the synchronized directory
- “poll_interval” says how often (in seconds) to poll for updates</li>
<li>“local_snapshots”
- whatever <a class="reference external" href="https://github.com/LeastAuthority/magic-folder/issues/197">https://github.com/LeastAuthority/magic-folder/issues/197</a> says</li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright The Tahoe-LAFS Developers, The Magic-Folder Developers.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>