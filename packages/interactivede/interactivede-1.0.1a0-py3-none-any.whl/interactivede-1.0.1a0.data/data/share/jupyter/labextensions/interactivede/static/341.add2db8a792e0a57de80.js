"use strict";(self.webpackChunkinteractivede=self.webpackChunkinteractivede||[]).push([[341],{341:(t,e,r)=>{r.r(e),r.d(e,{default:()=>U});var s=r(767);class a{}window.IDEGlobal=a;const i=function(){const t=[];let e=null,r=null;function s(){var r;null===(r=null==e?void 0:e.model)||void 0===r||r.metadata.set("ext-ide-logs",t)}return setInterval((()=>{s()}),5e3),{log:function(e,r){r?t.push({name:e,date:new Date,data:r}):t.push({name:e,date:new Date})},print:function(e=!0){e?console.table(t):console.log({logEvents:t})},setNotebook:function(t){e=t},save:s,autoSave:function(t=5e3){r&&clearInterval(r),"number"==typeof t&&(r=setInterval((()=>{s()}),t))}}}();a.LOGGER=i,i.log("logging initialized"),i.save();var n=r(677);const o="application/vnd.trrack.graph+json",d="application/vnd.trrack+json";var c,l=r(840);class u{constructor(t){this._output=null,this._relayOutput=new l.Signal(this),this._future=null,this._onIOPub=t=>{switch(t.header.msg_type){case"execute_result":case"display_data":case"update_display_data":this._output=t.content,this._relayOutput.emit()}},this._ctx=t.sessionContext}static init(t){t.currentChanged.connect((async(t,e)=>{a.executor=e?new u(e):null}))}get hasFuture(){return Boolean(this._future)}get future(){if(!this._future)throw new Error("No future set");return this._future}set future(t){this._future=t,t&&(t.onIOPub=this._onIOPub)}get output(){return this._output}execute(t,{withIDE:e=!1,withPandas:r=!1,withJson:s=!1}={}){var a;s&&(t=c.withJson(t)),r&&(t=c.withPandas(t)),e&&(t=c.withIDE(t));const i=null===(a=this._ctx.session)||void 0===a?void 0:a.kernel;if(i)return this.future=i.requestExecute({code:t,stop_on_error:!0,store_history:!1}),this.future}}!function(t){t.withIDE=function(t){return`from interactivede.internal import *\n${t}`},t.withJson=function(t){return`import json\n${t}`},t.withPandas=function(t){return`import pandas as pd\n${t}`}}(c||(c={}));var h=r(841),g=r(431),p=r(526),v=r(757),_=r(41);class m{constructor(){this._isDisposed=!1}get isDisposed(){return this._isDisposed}set isDisposed(t){this._isDisposed=t}}function f(t){const e=[];return Object.entries(t).forEach((([t,r])=>{e.push({field:t,range:r})})),e}function w({manager:t,spec:e,selectionPath:r,trrackManager:s,cellId:i}){const n=r.parentProperty,o=r.pointer,{view:d,vegaRenderer:c}=t;if(!c||!d)throw new Error("Vega or view not found");const l=a.cells.get(i);if(!l)throw new Error("Cell doesn't exist");return function(t,e=300){let r;return(...s)=>{clearTimeout(r),r=setTimeout((()=>t(...s)),e)}}((async()=>{const t=d.getState().signals,r={selection:t[n],x:t[`${n}_x`],y:t[`${n}_y`]},a={};Object.entries(r.selection).forEach((([t,e])=>{a[t]=e}));const i=function(t,e,r){return(0,v.applyPatch)(JSON.parse(JSON.stringify(e)),[{op:"replace",path:`${r}/init`,value:(0,v.deepClone)(t)}]).newDocument}(a,e,o),c={id:p.UUID.uuid4(),type:"selection_interval",name:n,path:o,params:r,spec:i};await s.addInteraction(c,"Brush selection"),l.updateVegaSpec(i)}))}class k extends m{constructor(t,e,r){super(),this.vegaRenderer=e,this._listeners={},k.disposePrevious(),k.previous.push(this),this._cellId=t;const s=a.trracks.get(t);if(!s)throw new Error("No trrack manager found");this._tManager=s,a.views.set(t,this);const i=a.cells.get(t);if(!i)throw new Error("Cell doesn't exist");this._cell=i,this._originalVegaSpec=i.getoriginalSpec()||r,i.saveOriginalSpec(this._originalVegaSpec),this._tManager.currentChange.connect((()=>{const t=(0,v.deepClone)(this._tManager.trrack.getState().interactions).pop();i.updateVegaSpec(t?t.spec:this._originalVegaSpec)}),this)}static init(t,e,r){return new k(t,e,r)}static disposePrevious(){this.previous.forEach((t=>t.dispose())),this.previous=[]}dispose(){var t;this.isDisposed||(l.Signal.disconnectReceiver(this),this.isDisposed=!0,null===(t=this.view)||void 0===t||t.finalize(),a.views.delete(this._cellId))}get vega(){var t;return null===(t=this.vegaRenderer)||void 0===t?void 0:t.vega}get view(){var t;return null===(t=this.vega)||void 0===t?void 0:t.view}get spec(){return this.vega?this.vega.spec:this._originalVegaSpec}async removeBrushes(){}addListeners(){this.addSelectionListeners()}addSelectionListeners(){if(!this.view)return;this.removeSelectionListeners();const t=(0,_.JSONPath)({path:'$..selection[?(@parentProperty !== "encoding")]',json:this.spec,resultType:"all"});for(let e=0;e<t.length;++e){const r=t[e],s=r.value.type,a=r.parentProperty;if("interval"===s){const t=w({manager:this,spec:this.spec,selectionPath:r,trrackManager:this._tManager,cellId:this._cellId});this._listeners[a]=t,this.view.addSignalListener(a,t)}}}removeListeners(){this.removeSelectionListeners()}removeSelectionListeners(){var t;for(const e in this._listeners)null===(t=this.view)||void 0===t||t.removeSignalListener(e,this._listeners[e])}filter(){const t=this.spec;if(0===this._tManager.trrack.getState().interactions.filter((t=>"selection_interval"===t.type)).length)return;t.transform=t.transform||[];const e=[],r=(0,_.JSONPath)({path:'$..selection[?(@parentProperty !== "encoding")]',json:this.spec,resultType:"all"}),s=[];for(let t=0;t<r.length;++t){const a=r[t],i=a.value,n=null==i?void 0:i.init,o=a.value.type;n&&("interval"===o&&e.push({not:{and:f(n)}}),s.push({op:"remove",path:`${a.pointer}/init`}))}const a=(0,_.JSONPath)({path:"$..transform[?(@.filter)]",json:this.spec,resultType:"all"}),i=[].concat(...a.map((t=>t.value.filter.and)));console.log(e),console.log(i),console.log([...e,...i]);const n=(0,v.applyPatch)((0,v.deepClone)(t),(0,v.deepClone)([...s,{op:"add",path:"/transform",value:[]},{op:"add",path:"/transform/0",value:{filter:{}}},{op:"add",path:"/transform/0/filter",value:{and:[...e,...i]}}])).newDocument;this._tManager.addInteraction({id:p.UUID.uuid4(),type:"filter",path:"",spec:n}),this._cell.updateVegaSpec(n)}}k.previous=[];class y extends h.RenderedCommon{constructor(t){super(t),this._vegaManager=null,this.renderedVega=null,this.panelLayout=new g.PanelLayout,this.widgetA=new g.Panel,this.widgetB=new g.Panel,this.currentVisible="A",this.opts=t,this.addClass("vega-parent"),this.widgetA.addClass("vega-child"),this.widgetB.addClass("vega-child"),this.panelLayout.addWidget(this.widgetA),this.panelLayout.addWidget(this.widgetB),"A"===this.currentVisible?this.widgetB.hide():this.widgetA.hide(),this.layout=this.panelLayout}get mimetype(){return"application/vnd.vegalite.v4+json"}get vega(){var t;return null===(t=this.renderedVega)||void 0===t?void 0:t._result}async renderModel(t){await this.render(t)}async render(t){var e;const r=t.metadata.cellId;if(!r)throw new Error("No cellId found");if(this._vegaManager=k.init(r,this,function(t){const e=Object.keys((null==t?void 0:t.data)||{}).find((t=>t.includes("vegalite")&&t.includes("v4")));if(!e)throw new Error("No vegalite4 spec");const r=null==t?void 0:t.data[e];if(!r)throw new Error("No vegalite4 spec");return r}(t)),this.renderedVega=new n.RenderedVega(this.opts),await this.renderedVega.renderModel(t),"A"===this.currentVisible){for(;this.widgetB.widgets.length>0;)this.widgetB.layout.widgets[0].dispose(),this.widgetB.layout.removeWidgetAt(0);this.widgetB.node.textContent="",this.widgetB.addWidget(this.renderedVega),this.widgetB.show(),this.widgetA.hide(),this.currentVisible="B"}else{for(;this.widgetB.widgets.length>0;)this.widgetB.layout.widgets[0].dispose(),this.widgetB.layout.removeWidgetAt(0);this.widgetA.node.textContent="",this.widgetA.addWidget(this.renderedVega),this.widgetA.show(),this.widgetB.hide(),this.currentVisible="A"}return y.previousRenderedVega&&y.previousRenderedVega.dispose(),y.previousRenderedVega=this.renderedVega,null===(e=this._vegaManager)||void 0===e||e.addListeners(),Promise.resolve()}dispose(){var t;null===(t=this._vegaManager)||void 0===t||t.dispose(),super.dispose()}}y.previousRenderedVega=null;class C extends h.RenderedCommon{constructor(t){super(t),this._trrackCurrentId="",this._currentRenderedData="",this.addClass("lm-Panel"),this.layout=this._panelLayout=new g.PanelLayout,this.addClass("trrack-OutputArea-output"),this._regularOutputWidget=new g.Panel,this._trrackOutputWidget=new g.Panel,this._regularOutputWidget.id="regular",this._trrackOutputWidget.id="trrack",this._regularOutputWidget.addClass("trrack-OutputArea-executeResult"),this._regularOutputWidget.addClass("jp-OutputArea-output"),this._panelLayout.addWidget(this._regularOutputWidget),this._trrackOutputWidget.addClass("trrack-OutputArea-trrack"),this._panelLayout.addWidget(this._trrackOutputWidget)}async renderModel(t){this.toggleClass("jp-mod-trusted",t.trusted),await this.render(t);const{fragment:e}=t.metadata||{};e&&this.setFragment(e)}async render(t){var e,r;const{renderMimeRegistry:s}=a,i=t.data[d];if(!i)return Promise.resolve();const{[o]:n,...c}=i,l=n,u=[];if(l){const i=a.trracks.get(l);if(this._trrackCurrentId!==(null==i?void 0:i.current)){for(this._trrackCurrentId=(null==i?void 0:i.current)||"";this._trrackOutputWidget.widgets.length>0;)null===(e=this._trrackOutputWidget.layout)||void 0===e||e.widgets[0].dispose(),null===(r=this._trrackOutputWidget.layout)||void 0===r||r.removeWidgetAt(0);const a={...t,metadata:t.metadata||{},data:{[o]:l}},n=s.createRenderer(o),d=n.renderModel(a).then((()=>{this._trrackOutputWidget.addWidget(n)}));u.push(d)}}if(c&&this._currentRenderedData!==JSON.stringify(c)){this._currentRenderedData=JSON.stringify(c);const e=s.preferredMimeType(c);if(!e)return Promise.resolve();const{[e]:r}=c;if(!r)return Promise.resolve();const a={trusted:t.trusted,metadata:{...t.metadata||{},cellId:l},data:{[e]:r},setData(t){}},i=s.createRenderer(e);i.id=p.UUID.uuid4();const n=i.renderModel(a).then((()=>{i.addClass("enable-scroll"),this._regularOutputWidget.addWidget(i),this._regularOutputWidget.widgets.forEach((t=>{var e;t.id!==i.id&&(null===(e=this._regularOutputWidget.layout)||void 0===e||e.removeWidget(t))}))}));u.push(n)}return Promise.all(u).then((()=>{var t;null===(t=a.cells.get(l))||void 0===t||t.addOutputWidget(this._panelLayout)}))}}var S=r(510),I=r(271),O=r.n(I),x=r(626);function P({manager:t}){const{trrack:e}=t,[r,s]=(0,I.useState)(e.current.id),{verticalSpace:a,marginTop:i,gutter:n}={verticalSpace:25,marginTop:25,gutter:25};return(0,I.useEffect)((()=>{const e=(t,{currentNode:e})=>{s(e)};return t.currentChange.connect(e),()=>{t.currentChange.disconnect(e)}}),[t]),O().createElement(x.ProvVis,{root:e.root.id,config:{changeCurrent:t=>{e.to(t)},labelWidth:100,verticalSpace:a,marginTop:i,marginLeft:15,gutter:n},nodeMap:e.graph.backend.nodes,currentNode:r})}class W extends S.ReactWidget{constructor(t){super();const e=a.trracks.get(t);if(!e)throw new Error("TrrackManager not found");this._tManager=e,this._hasVegaPlot=Boolean(a.views.get(t)),this.toggle(this._hasVegaPlot)}toggle(t){this.toggleClass("jp-TrrackVisWidget-hide",!t)}render(){return O().createElement(P,{manager:this._tManager})}}class M extends h.RenderedCommon{constructor(t){super(t),this.layout=this._panelLayout=new g.PanelLayout}render(t){const e=t.data[o],r=new W(e);return this._panelLayout.addWidget(r),Promise.resolve()}}class b{constructor(t){u.init(t)}createNew(t,e){t.content.rendermime.addFactory({...n.rendererFactory,defaultRank:(n.rendererFactory.defaultRank||10)-1,createRenderer:t=>new y(t)}),t.content.rendermime.addFactory({safe:!0,mimeTypes:[d],defaultRank:10,createRenderer:t=>new C(t)}),t.content.rendermime.addFactory({safe:!0,mimeTypes:[o],defaultRank:10,createRenderer:t=>new M(t)}),a.trracks=new Map,a.views=new Map,a.cells=new Map,a.renderMimeRegistry=t.content.rendermime}}const R={id:"interactivede:plugin",autoStart:!0,requires:[s.INotebookTracker],activate:function(t,e){i.log("JupyterLab extension interactivede is activated!"),console.log("JupyterLab extension interactivede is activated!"),t.docRegistry.addWidgetExtension("notebook",new b(e))}};var E=r(952),L=r(591);const V="jp-OutputHeaderWidget-btn",D=[];class N extends O().Component{constructor(t){super(t);const e=this.props.cell,r=a.trracks.get(e.cellId);if(!r)throw new Error("Can't find TrrackManager for cell");this.fn=(t,e)=>{const s=this.state;s.reset.disabled=r.hasOnlyRoot,s.filter.disabled=!1,this.setState(s)},r.currentChange.connect(this.fn,this),this.manager=r,this.state={reset:{disabled:r.hasOnlyRoot,action:()=>r.reset()},filter:{disabled:!1,action:()=>async function(t){const e=function(t){const e=t.cellId,r=a.views.get(e);if(!r)return;const s=a.trracks.get(e);return s?{vega:r,trrack:s}:void 0}(t);if(!e)return;const{vega:r,trrack:s}=e;(r||s)&&r.filter()}(this.props.cell)},dataFrameList:D}}componentWillUnmount(){this.manager.currentChange.disconnect(this.fn,this)}render(){const{reset:t,filter:e}=this.state;return O().createElement(O().Fragment,null,O().createElement(L.Button,{disabled:t.disabled,onClick:t.action,className:V},"Reset"),O().createElement(L.Button,{disabled:e.disabled,onClick:e.action,className:V},"Filter"),O().createElement(L.Button,{onClick:()=>{var t,e,r,s;console.clear();const i=a.views.get(this.props.cell.cellId);if(!i)return;const n=(0,_.JSONPath)({path:"$..data..name",json:(null===(t=i.vega)||void 0===t?void 0:t.vgSpec)||{},resultType:"all"}).find((t=>t.value.includes("source"))),o=null===(e=i.vega)||void 0===e?void 0:e.view.data(n.value),d=JSON.stringify(o),c=`data_${this.manager.current}`;null===(s=null===(r=a.executor)||void 0===r?void 0:r.execute(`ext_df = pd.read_json('${d}')`,{withPandas:!0}))||void 0===s||s.done.then((()=>{this.state.dataFrameList.includes(c)||(this.setState((t=>({dataFrameList:[...t.dataFrameList,c]}))),D.push(c))}))},className:V},"Extract dataframe"))}}class A extends S.ReactWidget{constructor(t){super(),this._cell=t,this.addClass("jp-OutputHeaderWidget"),this._hasVegaPlot=Boolean(a.views.get(t.cellId)),this.toggle(this._hasVegaPlot)}toggle(t){this.toggleClass("jp-OutputHeaderWidget-hide",!t)}render(){return this._hasVegaPlot?O().createElement(N,{cell:this._cell}):null}}var T=r(452);const B={msg:"Hello, World!",interactions:[]};(0,T.createAction)("test"),(0,T.createAction)("select");class J{static create(t){return function(t){const e=T.Registry.create(),r=e.register("test",((t,e)=>{t.msg=e})),s=e.register("interaction",((t,e)=>{t.interactions.push(e)}));let a=(0,T.initializeTrrack)({registry:e,initialState:B});return t&&"string"==typeof t?a.import(t):t&&"string"!=typeof t&&(a=(0,T.initializeTrrack)({registry:e,initialState:t})),{trrack:a,actions:{testAction:r,addInteractionAction:s}}}(t)}}const j="trrack_graph";class F extends m{constructor(t){super(),this._cell=t,this._trrackInstanceChange=new l.Signal(this),this._trrackCurrentChange=new l.Signal(this);const{trrack:e,actions:r}=this._reset(!0);this._trrack=e,this._actions=r}get savedGraph(){var t;return null===(t=this._cell.model.metadata)||void 0===t?void 0:t.get(j)}get trrack(){return this._trrack}get actions(){return this._actions}get isAtRoot(){return this.current===this.root}get isAtLatest(){return 0===this._trrack.current.children.length}get hasOnlyRoot(){return 0===this._trrack.root.children.length}get changed(){return this._trrackInstanceChange}get currentChange(){return this._trrackCurrentChange}get root(){return this._trrack.root.id}get current(){return this._trrack.current.id}async addInteraction(t,e){await this.trrack.apply(e||t.type,this.actions.addInteractionAction(t))}_reset(t){this._trrack&&a.trracks.delete(this._cell.cellId),console.log("reset"),this.currentChange.disconnect(this._saveTrrackGraphToModel,this);const{trrack:e,actions:r}=J.create(t?this.savedGraph:void 0);return this._trrack=e,this._actions=r,this._saveTrrackGraphToModel(),this._trrack.currentChange((()=>{this._trrackCurrentChange.emit({currentNode:this._trrack.current.id,state:this._trrack.getState()})})),this.currentChange.connect(this._saveTrrackGraphToModel,this),this._trrackInstanceChange.emit(this._trrack.root.id),this._trrackCurrentChange.emit({currentNode:this._trrack.current.id,state:this._trrack.getState()}),{trrack:e,actions:r}}_saveTrrackGraphToModel(){this._cell.model.metadata.set(j,this._trrack.export()),a.trracks.set(this._cell.cellId,this)}reset(){this._reset(!1)}dispose(){this.isDisposed||(this.isDisposed=!0,a.trracks.delete(this._cell.cellId),l.Signal.clearData(this))}}class $ extends E.CodeCell{constructor(t){super(t),this._trrackManager=new F(this),a.cells.set(this.cellId,this),this.model.outputs.fromJSON(this.model.outputs.toJSON()),this.model.outputs.changed.connect(this._outputChangeListener,this),this._trrackChangeHandler||this._trrackManager.changed.connect(this._trrackChangeHandler,this)}dispose(){this.isDisposed||(l.Signal.clearData(this),a.cells.delete(this.cellId),this._trrackManager.dispose(),super.dispose())}get cellId(){return this.model.id}get trrackId(){return this._trrackManager.root}get trrackManager(){return this._trrackManager}addOutputWidget(t){const e=t.widgets.length;if(e<2||e>3)throw new Error("Unexpected number of widgets in output area");3===e&&t.removeWidgetAt(0);const r=new A(this);t.insertWidget(0,r)}_trrackChangeHandler(){const t=this.model.outputs.toJSON().findIndex((t=>"execute_result"===t.output_type));if(-1===t)return;const e=this.model.outputs.get(t);"execute_result"===e.type&&e.setData({data:e.data,metadata:e.metadata||{}})}saveOriginalSpec(t){this.model.metadata.set("original_spec",t)}getoriginalSpec(){return this.model.metadata.get("original_spec")}updateVegaSpec(t){const e=this.model.outputs.toJSON().findIndex((t=>"execute_result"===t.output_type));if(-1===e)return;const r=this.model.outputs.get(e);"execute_result"===r.type&&r.setData({data:{[d]:{[n.VEGALITE4_MIME_TYPE]:t,[o]:this.cellId}},metadata:r.metadata||{}})}_outputChangeListener(t,{type:e,newIndex:r}){if("add"!==e)return;const s=t.get(r);if("execute_result"===s.type){if(s.data[d])return;s.setData({data:{[d]:{...s.data,[o]:this.cellId}},metadata:s.metadata||{}})}}}class G extends s.NotebookPanel.ContentFactory{createCodeCell(t,e){return new $(t).initializeState()}}const U=[R,{id:"interactivede:cell-factory",provides:s.NotebookPanel.IContentFactory,autoStart:!0,activate:()=>(console.log("Jupyterlab extension interactivede is activated! - cell-factory"),i.log("Jupyterlab extension interactivede is activated! - cell-factory"),new G)}]}}]);