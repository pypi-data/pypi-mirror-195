"use strict";(self.webpackChunktvb_ext_bucket=self.webpackChunktvb_ext_bucket||[]).push([[529],{529:(e,t,a)=>{a.r(t),a.d(t,{default:()=>O});var n=a(866),r=a(535),o=a(510),s=a(468),l=a(271),i=a.n(l),c=a(591);const u=({label:e,action:t,icon:a,onContextFinish:n})=>{const[r,o]=(0,l.useState)(!1),s=(0,l.useCallback)((async()=>{o(!0),await t(),n&&n(),o(!1)}),[]);return i().createElement("li",{onClick:s,className:"bucket-ContextMenu-item"},a&&i().createElement(a.react,null),i().createElement("p",{style:{paddingLeft:"0.5em"}},e),i().createElement("span",{className:"bucket-Spinner",style:{display:r?"inline-block":"none"}}))};var d=a(886),m=a(258);async function h(e="",t={}){const a=m.ServerConnection.makeSettings(),n=d.URLExt.join(a.baseUrl,"tvb_ext_bucket",e);let r;try{r=await m.ServerConnection.makeRequest(n,t,a)}catch(e){throw new m.ServerConnection.NetworkError(e)}let o=await r.text();if(o.length>0)try{o=JSON.parse(o)}catch(e){console.log("Not a JSON response body.",r)}if(!r.ok)throw new m.ServerConnection.ResponseError(r,o.message||o);return o}class b extends Error{}class p extends Error{}class v extends Error{}class f extends Error{}class g extends Error{}const w={current:null},k=e=>{let t="";for(let a=e.length-1;a>-1&&(t=e[a]+t,"."!==e[a]);a--);return t.startsWith(".")?t:""};class E{constructor(e){this._breadcrumbs=[],this._bucket=e.bucket,this._bucketEndpoint=e.bucketEndPoint,this._currentFiles=new Map}_buildBrowser(e){this._homeDirectory=new E.BucketDirectory("",e,this.bucket),this._currentDirectory=this._homeDirectory}get currentDirectory(){return this._currentDirectory}get bucket(){return this._bucket}set bucket(e){this._bucket=e}async getAvailableBuckets(){let e=[];try{e=await h("buckets")}catch(e){await(0,o.showErrorMessage)("ERROR","Could not get available buckets from server")}return e}ls(){return this.currentDirectory?this.currentDirectory.ls():[]}get breadcrumbs(){return this._breadcrumbs}async openBucket(){this._currentFiles.clear(),this._breadcrumbs=[];try{const e=await h(`${this._bucketEndpoint}?bucket=${this._bucket}`);e.success||await(0,o.showErrorMessage)("ERROR",e.message),this._buildBrowser(e.files)}catch(e){await(0,o.showErrorMessage)("ERROR",`Could not open bucket. ${e}`)}return this.currentDirectory}async cd(e){var t;const a=null===(t=this._currentDirectory)||void 0===t?void 0:t.directories.get(e);if(!a)throw new f(`Can't cd to directory ${e}! Directory doesn't seem to exist.`);this._currentDirectory=a,this._currentFiles.clear(),this._breadcrumbs.push(a);const n=this.breadcrumbs.reduce(((e,t)=>e+t.name+"/"),"");return console.log("Going to files in: ",n),a}async goTo(e){const t=[...this._breadcrumbs];let a=t.pop();for(;void 0!==a&&a.name!==e;)a=t.pop();if(void 0===a)throw new b(`Could not find breadcrumb ${e}`);return t.push(a),this._breadcrumbs=t,this._currentDirectory=a,a}}!function(e){class t{constructor(e,t,a,n){this.directories=new Map,this.files=new Map,this.isFile=!1,this.name=e,this.bucket=a,this.absolutePath=n||"",this._buildContents(t)}_buildContents(e){const n=new Map;for(const t of e)if(t.includes("/")){const e=t.slice(0,t.indexOf("/")),a=t.slice(t.indexOf("/")+1),r=n.get(e);r?r.push(a):n.set(e,[a])}else{const e=new a(t,this.absolutePath?`${this.absolutePath}/${t}`:t,this.bucket);this.files.set(e.name,e)}n.forEach(((e,a)=>{const n=this.absolutePath?`${this.absolutePath}/${a}`:a,r=new t(a,e,this.bucket,n);this.directories.set(a,r)}))}get filesCount(){return this.files.size}get directoriesCount(){return this.directories.size}ls(){const e=[];for(const t of this.directories.values())e.push(t);for(const t of this.files.values())e.push(t);return e}async upload(e,t){if(!await this._confirmOverride(t))return;const a=h(`upload?source_file=${e}&bucket=${this.bucket}&destination=${this.absolutePath}&filename=${t}`);console.log("result: ",a)}async getUploadUrl(e){if(!await this._confirmOverride(e))return"#";const t=await h(`local_upload?to_bucket=${this.bucket}&with_name=${e}&to_path=${encodeURIComponent(this.absolutePath)}`);return t.success||await(0,o.showErrorMessage)("Error","Could not get an upload url for this file!"),t.url}async _confirmOverride(e){return!this.files.get(e)||(await(0,o.showDialog)({title:"Warning!",body:"A file with this name already exists in this directory. If you continue it will be overwritten!",buttons:[o.Dialog.cancelButton({label:"Cancel"}),o.Dialog.okButton({label:"Continue"})]})).button.accept}}e.BucketDirectory=t;class a{constructor(e,t,a){this.isFile=!0,this._name=e,this.bucket=a,this._absolutePath=t,this._validate()}get name(){return this._name}get absolutePath(){return this._absolutePath}async download(){var e;try{const t=this.absolutePath;let a=null===(e=w.current)||void 0===e?void 0:e.model.path;a||(a=""),console.log("downloading to: ",a);const n=await h(`download?file=${encodeURIComponent(t)}&download_destination=${encodeURIComponent(a)}&bucket=${this.bucket}`);await(0,o.showDialog)({title:n.success?"Success!":"Failed!",body:`File ${this.name} was ${n.success?"":"not"} downloaded! \n ${n.message?n.message:""}`,buttons:[o.Dialog.okButton({label:"OK"})]})}catch(e){await(0,o.showErrorMessage)("Something went wrong!",e)}}async getDownloadUrl(){let e="";try{e=(await h(`download_url?file=${this.absolutePath}&bucket=${this.bucket}`)).url}catch(e){await(0,o.showErrorMessage)("Failed",e)}return e}async delete(){try{return await h(`objects/${encodeURIComponent(this.bucket)}/${encodeURIComponent(this.absolutePath)}`,{method:"DELETE"})}catch(e){await(0,o.showErrorMessage)("Failed",e)}}async rename(e){if(k(e)!==k(this.name)&&!(await(0,o.showDialog)({title:"Warning!",body:"If you change the file extension, the file might become unusable!",buttons:[o.Dialog.cancelButton({label:"Cancel"}),o.Dialog.okButton({label:"Continue"})]})).button.accept)return;const t=await h(`rename?path=${encodeURIComponent(this.absolutePath)}&new_name=${e}&bucket=${encodeURIComponent(this.bucket)}`);if(!t.success)throw new Error(`Could not rename file ${this.name} to ${e}!`);this._name=t.newData.name,this._absolutePath=t.newData.path}_validate(){if(!this.absolutePath.endsWith(this.name))throw new p(`Provided absolute path (${this.absolutePath}) does not lead to the provided file name (${this.name})!`)}}e.BucketFile=a}(E||(E={}));const y=(0,l.createContext)(void 0),C=({children:e})=>{const[t,a]=(0,l.useState)(""),n={fileBrowser:new E({bucketEndPoint:"buckets",bucket:t}),bucketName:t,setBucketName:a};return i().createElement(y.Provider,{value:n},e)},D=()=>{const e=(0,l.useContext)(y);if(void 0===e)throw new g("useBucketContext must be used within a BucketContextProvider");return e},_=({name:e,onContextFinish:t,renameAction:a,children:n})=>{const[r,s]=(0,l.useState)(!1),d=D().fileBrowser;(0,l.useEffect)((()=>{const e=()=>s(!1);return document.addEventListener("click",e),()=>document.removeEventListener("click",e)}),[]);const m=(0,l.useCallback)((e=>{e.preventDefault(),s((e=>!e))}),[s]),h=(0,l.useCallback)((async()=>{var t,a;const n=null===(t=d.currentDirectory)||void 0===t?void 0:t.files.get(e);n?await n.download():await(0,o.showErrorMessage)("Download failed!",`Can't find file ${e} in directory ${null===(a=d.currentDirectory)||void 0===a?void 0:a.name}`)}),[e]),b=(0,l.useCallback)((async()=>{var t,a;const n=null===(t=d.currentDirectory)||void 0===t?void 0:t.files.get(e);if(n){const t=await n.getDownloadUrl(),a=document.createElement("a");a.href=t,a.download=e,document.body.appendChild(a),a.click(),document.body.removeChild(a)}else await(0,o.showErrorMessage)("Download failed!",`Can't find file ${e} in directory ${null===(a=d.currentDirectory)||void 0===a?void 0:a.name}. Please refresh and try again!`)}),[e]),p=(0,l.useCallback)((async()=>{var t,a;const n=null===(t=d.currentDirectory)||void 0===t?void 0:t.files.get(e);if(n){const t=await n.delete();if(!t)return;await(0,o.showDialog)({title:t.success?"Success!":"Failed!",body:`File ${e} was ${t.success?"":"not"} deleted! \n ${t.message?t.message:""}`,buttons:[o.Dialog.okButton({label:"OK"})]})}else await(0,o.showErrorMessage)("Deletion failed!",`Can't find file ${e} in directory ${null===(a=d.currentDirectory)||void 0===a?void 0:a.name}. Please refresh and try again!`)}),[e]),v=(0,l.useCallback)((async()=>{var t;let a="";try{const n=null===(t=d.currentDirectory)||void 0===t?void 0:t.files.get(e);if(!n)return void await(0,o.showErrorMessage)("ERROR",`Could not get details on file ${e}. Please refresh and try again!`);a=await n.getDownloadUrl(),await(0,o.showDialog)({title:"Your share URL:",body:i().createElement(i().Fragment,null,i().createElement("a",{href:a,className:"bucket-ShareLink"},a),i().createElement("p",null,"Copy and paste this url in a browser to download the file!"),i().createElement("p",{style:{color:"red"}},"* If this bucket is private this link will expire very soon.")),buttons:[o.Dialog.okButton({label:"Close"})]})}catch(e){await(0,o.showErrorMessage)("ERROR",e)}}),[e]);return i().createElement("div",{onContextMenu:m,className:"bucket-ContextMenu-container"},n,i().createElement("div",{className:"bucket-ContextMenu","aria-label":"context-menu",onClick:e=>e.stopPropagation(),style:{display:r?"block":"none"}},i().createElement("ul",null,i().createElement(u,{label:"Download",action:h,icon:c.downloadIcon}),i().createElement(u,{label:"Local Download",action:b,icon:c.downloadIcon}),i().createElement(u,{label:"Delete",action:p,icon:c.closeIcon,onContextFinish:t}),i().createElement(u,{label:"Rename",action:()=>{a(),s(!1)},icon:c.editIcon}),i().createElement(u,{label:"Share download url",action:v,icon:c.linkIcon}))))},x=()=>i().createElement("span",{className:"bucket-DownloadAnimation"},i().createElement("i",{className:"fa fa-arrow-down"})),$=()=>i().createElement("span",{className:"bucket-UploadAnimation"},i().createElement(c.fileUploadIcon.react,null)),S=({children:e,file:t})=>{const[a,n]=(0,l.useState)(!1),r=(0,l.useCallback)((e=>e.clientX>20&&e.clientX<280),[]),o=(0,l.useCallback)((async e=>{e.preventDefault(),e.stopPropagation(),r(e)&&(n(!0),await t.download(),n(!1))}),[]);return i().createElement("div",{draggable:!a,onDragEnd:o,className:"align-flex-horizontal"},e,a&&i().createElement(x,null))};function N({tag:e,metadata:t,onClick:a,onContextFinish:n}){const[r,s]=(0,l.useState)(!1),u=D().fileBrowser,d=(0,l.useRef)(null),[m,h,b]=(({hasLoader:e,displayInfo:t})=>{const[a,n]=(0,l.useState)(!1),[r,o]=(0,l.useState)(t||""),s={display:a?"flex":"none"};return[()=>i().createElement("div",{style:s,className:"bucket-Tooltip"},e&&i().createElement("span",{className:"bucket-Spinner"}),i().createElement("p",null,r)),o,n]})({hasLoader:!0});(0,l.useEffect)((()=>{var e;const t=async e=>{var a;e.stopPropagation(),"Enter"===e.key&&(e.preventDefault(),b(!0),h("Renaming file..."),await p(),b(!1),null===(a=d.current)||void 0===a||a.removeEventListener("keypress",t),s(!1))};return r&&(null===(e=d.current)||void 0===e||e.addEventListener("keypress",t)),()=>{var e;return null===(e=d.current)||void 0===e?void 0:e.removeEventListener("keypress",t)}}),[r]);const p=async()=>{var e;const a=null===(e=u.currentDirectory)||void 0===e?void 0:e.files.get(t.name);if(a)try{const e=d.current?d.current.value:t.name;await a.rename(e),await n()}catch(e){await(0,o.showErrorMessage)("Failed to rename",e)}else{const e=`File ${t.name} could not be found!`;(0,o.showErrorMessage)("ERROR",e).then((()=>console.error(e)))}};return i().createElement(P.Wrapper,{tag:e},t.isFile?i().createElement(c.fileIcon.react,{tag:"span",right:"7px",className:"jp-DirListing-itemIcon"}):i().createElement(c.folderIcon.react,{tag:"span",right:"7px",className:"jp-DirListing-itemIcon"}),t.isFile?i().createElement(_,{name:t.name,onContextFinish:n,renameAction:()=>s(!0)},i().createElement(m,null),i().createElement(S,{file:t},r?i().createElement("input",{"aria-label":"rename-input",defaultValue:t.name,ref:d}):i().createElement("p",{onClick:a},t.name))):i().createElement("p",{onClick:a,style:{cursor:"pointer"}},t.name))}var P;!function(e){e.Wrapper=({tag:e,children:t})=>i().createElement(i().Fragment,null,"li"===e?i().createElement("li",{className:"bucket-BrowserListItem"},t):i().createElement("div",null,t))}(P||(P={}));const R=e=>!1===e.show?i().createElement(i().Fragment,null):i().createElement("div",{className:"jp-SpinnerContent"});var L=a(694),F=a(526);const B=({show:e,finishAction:t})=>{const[a,n]=(0,l.useState)("default"),[r,s]=(0,l.useState)(!1),c=(0,l.useRef)(r);(0,l.useEffect)((()=>{c.current=r}),[r]);const u=(0,l.useRef)(null),d=D().fileBrowser,m=(0,l.useMemo)((()=>({title:"Not allowed!",error:"Please wait for the previous upload to finish!"})),[]),h=(0,l.useCallback)((e=>{var t;if(2===e.button)return;const a=e.target,n=null===(t=w.current)||void 0===t?void 0:t.selectedItems();if(null==n)return;const r=[];let o=!1,s=null==n?void 0:n.next();for(;s;)r.push(s),s.name===(null==a?void 0:a.innerText)&&(o=!0),s=null==n?void 0:n.next();if(!o)return void console.warn("Did not start a drag operation!");const l=r[0],i={source:l,action:async()=>{var e;const[t,a]=[l.path,l.name];await(null===(e=d.currentDirectory)||void 0===e?void 0:e.upload(t,a))}},c=new L.Drag({mimeData:new F.MimeData,source:i,proposedAction:"copy"});c.mimeData.setData("text/plain",JSON.stringify(l)),c.start(e.clientX,e.clientY).then((()=>console.log("drag ended")))}),[]),b=(0,l.useMemo)((()=>{const e={handleEvent:t=>{switch(console.log("handling: ",t.type),t.type){case"lm-dragenter":e._dragEnter(t);break;case"lm-dragover":e._dragOver(t);break;case"lm-drop":e._drop(t).then((()=>console.log("drop handled")));break;case"lm-dragleave":e._dragLeave(t)}},_dragEnter:e=>{e.preventDefault(),e.stopPropagation(),n("hover"),L.Drag.overrideCursor("pointer")},_dragOver:e=>{e.preventDefault(),e.stopPropagation(),e.dropAction=e.proposedAction,L.Drag.overrideCursor("pointer"),n("hover")},_dragLeave:e=>{e.preventDefault(),e.stopPropagation(),L.Drag.overrideCursor("auto"),n("default")},_drop:async e=>{e.preventDefault(),e.stopPropagation(),c.current?await(0,o.showErrorMessage)(m.title,m.error):(s(!0),e.source&&e.source.action?(await e.source.action(),await t()):console.warn("Did not upload file to bucket since drag initiator does not provide an action!"),L.Drag.overrideCursor("auto"),n("default"),s(!1))}};return e}),[]);(0,l.useEffect)((()=>{var e,t,a,n,r;null===(e=u.current)||void 0===e||e.addEventListener("lm-dragenter",b),null===(t=u.current)||void 0===t||t.addEventListener("lm-dragleave",b),null===(a=u.current)||void 0===a||a.addEventListener("lm-dragover",b),null===(n=u.current)||void 0===n||n.addEventListener("lm-drop",b);const o=null===(r=w.current)||void 0===r?void 0:r.node;return null==o||o.addEventListener("mousedown",h),()=>{var e,t,a,n;null==o||o.removeEventListener("mousedown",h),null===(e=u.current)||void 0===e||e.removeEventListener("lm-dragenter",b),null===(t=u.current)||void 0===t||t.removeEventListener("lm-dragleave",b),null===(a=u.current)||void 0===a||a.removeEventListener("lm-dragover",b),null===(n=u.current)||void 0===n||n.removeEventListener("lm-drop",b)}}),[]);const p=(0,l.useCallback)((e=>{e.preventDefault(),n("hover")}),[]),v=(0,l.useCallback)((e=>{e.preventDefault(),n("default")}),[]),f=(0,l.useCallback)((async e=>{var a,r;if(e.preventDefault(),e.stopPropagation(),c.current)await(0,o.showErrorMessage)(m.title,m.error);else{if(s(!0),e.dataTransfer.files&&e.dataTransfer.files[0])if(e.dataTransfer.files.length>1)await(0,o.showErrorMessage)("Unsupported","Currently you can only upload a file at a time!");else try{const n=e.dataTransfer.files[0],s=n.name,l=await(null===(a=d.currentDirectory)||void 0===a?void 0:a.getUploadUrl(s));if(!l)return;(await fetch(l,{method:"PUT",body:n})).ok&&(await(0,o.showDialog)({title:"Upload Success!",body:`${s} was uploaded to ${null===(r=d.currentDirectory)||void 0===r?void 0:r.absolutePath}/${s}`,buttons:[o.Dialog.okButton({label:"OK"})]}),await t())}catch(e){await(0,o.showErrorMessage)("Upload Failed",e)}s(!1),n("default")}}),[]);return i().createElement("div",{className:`bucket-DropZone ${a}`,ref:u,onDragOver:p,onDragLeave:v,onDrop:f,style:{display:e?"block":"none"}},r?i().createElement(i().Fragment,null,i().createElement("p",{className:"bucket-text-info"},"Uploading files..."),i().createElement($,null)):i().createElement("p",{className:"bucket-text-info"},"Drop your files here for upload."))},M=({data:e,showList:t})=>i().createElement("div",null,e.loading?i().createElement("span",{className:"jp-Spinner"}):i().createElement(i().Fragment,null,i().createElement("span",{className:"error"},e.error.toString()),i().createElement("select",{name:"bucket",id:"bucket",autoFocus:!0,value:e.chosenValue,onChange:t=>e.setChosenValue(t.target.value),style:{display:"none"}},e.searchMatchingValues.map((e=>i().createElement("option",{value:e,key:e},e)))),i().createElement("ul",{className:"available-buckets",style:{visibility:t?"visible":"hidden"}},e.searchMatchingValues.map((t=>i().createElement("li",{onClick:a=>{e.setChosenValue(t)},key:t},t)))))),I=()=>{const[e,t]=(0,l.useState)(null),[a,n]=(0,l.useState)(!1),[r,o]=(0,l.useState)(!1),s=D().fileBrowser,u=(0,l.useCallback)((e=>()=>{n(!0),e().then((()=>{n(!1)}))}),[]),d=(0,l.useCallback)(u((async()=>{const e=await s.openBucket();e&&t(e)})),[s]),m=(()=>{const[e,t]=(0,l.useState)(!0),[a,n]=(0,l.useState)(""),[r,o]=(0,l.useState)([]),[s,i]=(0,l.useState)(""),[c,u]=(0,l.useState)(s),[d,m]=(0,l.useState)([]);return(0,l.useEffect)((()=>{let e=!0;return e&&h("buckets_list").then((e=>{o(e),m(e),t(!1)})).catch((e=>{n(e)})),()=>{e=!1}}),[]),(0,l.useEffect)((()=>{const e=[];for(const t of r)t.includes(s)&&e.push(t);m(e)}),[s]),(0,l.useEffect)((()=>{i(c)}),[c]),{loading:e,searchValue:s,setSearchValue:i,searchMatchingValues:d,error:a,chosenValue:c,setChosenValue:u}})();return(0,l.useEffect)((()=>{s.bucket=m.searchValue}),[m.searchValue]),(0,l.useEffect)((()=>{s.bucket=m.chosenValue}),[m.chosenValue]),i().createElement(i().Fragment,null,i().createElement("div",null,i().createElement("div",{className:"bucket-logo"},i().createElement("span",{className:"collab-logo"}),i().createElement("span",{className:"bucket-logo-text"},"Bucket")),i().createElement("input",{type:"text",value:m.searchValue,"aria-label":"bucket-name-input",placeholder:"bucket-name",onChange:e=>m.setSearchValue(e.target.value),onFocus:e=>o(!0),onBlur:e=>setTimeout((()=>o(!1)),500)}),i().createElement("button",{onClick:d},"Connect!"),i().createElement(M,{data:m,showList:r})),i().createElement("div",{className:"bucket-BreadCrumbs"},i().createElement(c.folderIcon.react,{tag:"span",className:"bucket-home"}),s.breadcrumbs.map(((e,a)=>i().createElement("span",{key:a,className:"bucket-BreadCrumbs-Item","aria-label":`breadcrumb-${a}`,onClick:u((async()=>{const e=await s.goTo(s.breadcrumbs[a].name);t(e)}))},e.name,"/")))),i().createElement(R,{show:a}),i().createElement("ul",{style:{display:a?"none":"block"},className:"scrollableY"},null==e?void 0:e.ls().map((e=>{let a=()=>{};return e.isFile||(a=u((async()=>{const a=await s.cd(e.name);t(a)}))),i().createElement(N,{tag:"li",metadata:e,key:e.name,onClick:a,onContextFinish:d})}))),i().createElement(B,{show:!a&&null!==e,finishAction:d}))};class U extends o.ReactWidget{constructor(){super(),this.addClass("tvb-bucketWidget")}render(){return i().createElement("div",{className:"bucket-container"},i().createElement(C,null,i().createElement(I,null)))}}const O={id:"tvb-ext-bucket:plugin",autoStart:!0,requires:[o.ICommandPalette,n.ILayoutRestorer,s.IConsoleTracker,n.ILabShell,r.IFileBrowserFactory],activate:(e,t,a,n,r,s)=>{console.log("JupyterLab extension tvb-ext-bucket is activated!");const l=s.defaultBrowser;w.current=l;const i="tvb-ext-bucket",c=new U;c.id=i,c.title.iconClass="bucket-CollabLogo jp-SideBar-tabIcon",c.title.caption="Bucket",r.add(c,"right",{rank:200});const u=new o.WidgetTracker({namespace:"bucket"});a.add(c,i),a.restore(u,{command:"tvbextbucket:open",name:()=>"bucket"})}}}}]);